<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Heimdall Project Forum</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            text-align: center;
            background-color: #E0B0FF;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
        }
        .signup-btn {
            padding: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }

        .signup-btn:hover {
            background-color: #0056b3;
        }
        .post {
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            background: white;
            width: 90%;
            position: relative;
        }
        .comment-section {
            margin-top: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
        }

        .comment-input {
            width: calc(100% - 22px);
            padding: 8px;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .comment-btn {
            margin-top: 5px;
            padding: 6px 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .comment-btn:hover {
            background-color: #0056b3;
        }

        .comment {
            background: white;
            padding: 8px;
            border-radius: 5px;
            margin-top: 5px;
            position: relative;
            text-align: left;
        }

        .delete-btn {
            background-color: red;
            color: white;
            border: none;
            padding: 5px;
            cursor: pointer;
            border-radius: 5px;
        }

        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #333;
            padding: 10px 0;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .nav-bar a {
            color: white;
            text-decoration: none;
            padding: 12px 20px;
            display: inline-block;
            font-size: 16px;
            transition: background 0.3s, color 0.3s;
        }

        .nav-bar a:hover {
            background: #555;
            border-radius: 5px;
        }

        .container {
            margin-top: 60px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="nav-bar">
            <a href="index.html">Home</a>
            <a href="pagetwo.html">Forum</a>
            <a href="contacts.html">The Heimdall Project</a>
        </div>
        <h1>The Heimdall Project</h1>
        <h2>Create a New Post</h2>
        <input type="text" id="title" placeholder="Title">
        <textarea id="content" placeholder="Content"></textarea>
        <button onclick="submitPost()">Submit</button>

        <div id="posts"></div>
    </div>
 <!-- Firebase SDK -->
    <script type="module">
        import {
            initializeApp,
        getFirestore, 
        collection, 
        addDoc, 
        getDocs, 
        deleteDoc, 
        doc, 
        query, 
        orderBy 
    } from 'https://www.gstatic.com/firebasejs/9.x.x/firebase-app.js';

   // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBHwbrWIH_PncwBr_bYMI2vK3fdN0wVuzI",
  authDomain: "proj-2453b.firebaseapp.com",
  projectId: "proj-2453b",
  storageBucket: "proj-2453b.firebasestorage.app",
  messagingSenderId: "389300487180",
  appId: "1:389300487180:web:c2eb4d8600ff2867c19a29",
  measurementId: "G-BM0PX58TPY"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);
        // Import Firebase functions
        import { 
            createPost, 
            getPosts, 
            deletePost, 
            addComment, 
            getComments, 
            deleteComment, 
            migrateLocalStorageToFirestore,
        } from './firebase.js';

        // Make functions available globally
        window.createPost = createPost;
        window.getPosts = getPosts;
        window.deletePost = deletePost;
        window.addComment = addComment;
        window.getComments = getComments;
        window.deleteComment = deleteComment;
        window.migrateLocalStorageToFirestore = migrateLocalStorageToFirestore;
        
        // Initialize the page
        document.addEventListener("DOMContentLoaded", loadPosts);
    </script>

    <script>
        async function loadPosts() {
            try {
                const posts = await window.getPosts();
                displayPosts(posts);
            } catch (error) {
                console.error("Error loading posts:", error);
                document.getElementById("posts").innerHTML = `
                    <div class="post">
                        <p>Error loading posts. Please try again later.</p>
                    </div>
                `;
            }
        }
        
        function displayPosts(posts) {
            const postsContainer = document.getElementById("posts");
            if (!postsContainer) return;
            
            postsContainer.innerHTML = "";
            
            if (posts.length === 0) {
                postsContainer.innerHTML = `
                    <div class="post">
                        <p>No posts yet. Be the first to create one!</p>
                    </div>
                `;
                return;
            }
            
            posts.forEach((post) => {
                const postContainer = document.createElement("div");
                postContainer.classList.add("post");
                
                postContainer.innerHTML = `
                    <button class="post-delete-btn" onclick="handleDeletePost('${post.id}')">Delete</button>
                    <h3>${post.title}</h3>
                    <p>${post.content}</p>
                    <span class="timestamp">Posted on: ${new Date(post.timestamp).toLocaleString()}</span>
                    <button class="comments-toggle" onclick="toggleComments('${post.id}')">Show Comments</button>
                    <div id="comments-section-${post.id}" class="comment-section" style="display: none;">
                        <div id="comments-${post.id}">Loading comments...</div>
                        <input type="text" id="comment-input-${post.id}" class="comment-input" placeholder="Write a comment...">
                        <button class="comment-btn" onclick="handleAddComment('${post.id}')">Add Comment</button>
                    </div>
                `;
                
                postsContainer.appendChild(postContainer);
            });
        }
        
        async function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-section-${postId}`);
            const toggleButton = commentsSection.previousElementSibling;
            
            if (commentsSection.style.display === "none") {
                commentsSection.style.display = "block";
                toggleButton.textContent = "Hide Comments";
                await loadComments(postId);
            } else {
                commentsSection.style.display = "none";
                toggleButton.textContent = "Show Comments";
            }
        }
        
        async function loadComments(postId) {
            try {
                const commentsContainer = document.getElementById(`comments-${postId}`);
                commentsContainer.innerHTML = "Loading comments...";
                document.getElementById(`comments-${postId}`).innerHTML = `
    <p>Error loading comments. Please try again later.</p>
`;
                const comments = await window.getComments(postId);
                
                if (comments.length === 0) {
                    commentsContainer.innerHTML = "<p>No comments yet. Be the first to comment!</p>";
                    return;
                }
                
                commentsContainer.innerHTML = "";
                comments.forEach(comment => {
                    const commentElement = document.createElement("div");
                    commentElement.classList.add("comment");
                    commentElement.innerHTML = `
                        <button class="delete-btn" onclick="handleDeleteComment('${comment.id}', '${postId}')">X</button>
                        <p>${comment.text}</p>
                        <span class="timestamp">Posted on: ${new Date(comment.timestamp).toLocaleString()}</span>
                    `;
                    commentsContainer.appendChild(commentElement);
                });
            } catch (error) {
                console.error("Error loading comments:", error);
                document.getElementById(`comments-${postId}`).innerHTML = `
                    <p>Error loading comments. Please try again later.</p>
                `;
            }
        }
        
        async function submitPost() {
            await window.createPost({ title, content, authorIP });
            const title = document.getElementById("title").value.trim();
            const content = document.getElementById("content").value.trim();
            
            if (!title || !content) {
                alert("Title and content are required!");
                return;
            }
            
            try {
                
                // Clear form
                document.getElementById("title").value = "";
                document.getElementById("content").value = "";
                
            
                // Reload posts
                await loadPosts();
            } catch (error) {
                console.error("Error creating post:", error);
                alert("Error creating post. Please try again later.");
            }
        }
        
        async function handleDeletePost(postId) {
            if (confirm("Are you sure you want to delete this post? This action cannot be undone.")) {
                try {
                    await window.deletePost(postId);
                    await loadPosts();
                } catch (error) {
                    console.error("Error deleting post:", error);
                    alert("Error deleting post. Please try again later.");
                }
            }
        }
        window.getUserIP = async () => {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch (error) {
        throw new Error('Failed to fetch IP address');
    }
};
        async function handleAddComment(postId) {
            await window.addComment(postId, { text: commentText, authorIP });
            const authorIP = await window.getUserIP();
await window.addComment(postId, { text: commentText, authorIP });
            const commentInput = document.getElementById(`comment-input-${postId}`);
            const commentText = commentInput.value.trim();
            
            if (!commentText) {
                alert("Comment text is required!");
                return;
            }
            
            try {
                await window.addComment(postId, commentText);
                commentInput.value = "";
                await loadComments(postId);
            } catch (error) {
                console.error("Error adding comment:", error);
                alert("Error adding comment. Please try again later.");
            }
        }
        
        async function handleDeleteComment(commentId, postId) {
            if (confirm("Are you sure you want to delete this comment?")) {
                try {
                    await window.deleteComment(commentId, postId);
                    await loadComments(postId);
                } catch (error) {
                    console.error("Error deleting comment:", error);
                    alert("Error deleting comment. Please try again later.");
                }
            }
        }
        async function migrateData() {
            if (confirm("This will migrate all posts and comments from localStorage to Firebase. Continue?")) {
                try {
                    await window.migrateLocalStorageToFirestore();
                    alert("Migration completed successfully!");
                    await loadPosts();
                } catch (error) {
                    console.error("Error during migration:", error);
                    alert("Error during migration. Please try again later.");
                }
            }
        }
    </script>
</body>

</html>
